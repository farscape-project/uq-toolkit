# This file is copied from moose/modules/thermal_hydraulics/test/tests/components/heat_transfer_from_external_app_1phase
# In this case, I modified the initial_T and initial_T_wall, to check if it effected the cubic domain.

# temp0 = 290.0
# tempWall0 = 290.0
core_dia = 0.1
# area = ${3.141 * core_dia * core_dia / 4.}

# params from Barrett 2022. Coolant is water
density = 1000 # kg / m^3
inlet_temp = 400 #606 # 333 C
p_out = 15.5e5 # MPa # not clear what outlet pressure is, think this value is inlet
vol_flowrate = 0.001 # 650 L / min

n_elems_axial=100

# rho = 8000.0
# cp = 500.0
# k = 15.0


[GlobalParams]
  initial_p = ${p_out}
  initial_vel = 0.1
  initial_T = ${inlet_temp}

    closures = thm_closures

  rdg_slope_reconstruction = minmod
  scaling_factor_1phase = '1 1e-2 1e-4'
[]

[Functions]
  [water-htc-function]
    type = PiecewiseLinear
    scale_factor = 1.0
    axis = x
    x = '293.15 294.15 295.15 296.15 297.15 298.15 299.15 300.15 301.15 302.15 303.15 304.15 305.15 306.15 307.15 308.15 309.15 310.15 311.15 312.15 313.15 314.15 315.15 316.15 317.15 318.15 319.15 320.15 321.15 322.15 323.15 324.15 325.15 326.15 327.15 328.15 329.15 330.15 331.15 332.15 333.15 334.15 335.15 336.15 337.15 338.15 339.15 340.15 341.15 342.15 343.15 344.15 345.15 346.15 347.15 348.15 349.15 350.15 351.15 352.15 353.15 354.15 355.15 356.15 357.15 358.15 359.15 360.15 361.15 362.15 363.15 364.15 365.15 366.15 367.15 368.15 369.15 370.15 371.15 372.15 373.15 374.15 375.15 376.15 377.15 378.15 379.15 380.15 381.15 382.15 383.15 384.15 385.15 386.15 387.15 388.15 389.15 390.15 391.15 392.15 393.15 394.15 395.15 396.15 397.15 398.15 399.15 400.15 401.15 402.15 403.15 404.15 405.15 406.15 407.15 408.15 409.15 410.15 411.15 412.15 413.15 414.15 415.15 416.15 417.15 418.15 419.15 420.15 421.15 422.15 423.15 424.15 425.15 426.15 427.15 428.15 429.15 430.15 431.15 432.15 433.15 434.15 435.15 436.15 437.15 438.15 439.15 440.15 441.15 442.15 443.15 444.15 445.15 446.15 447.15 448.15 449.15 450.15 451.15 452.15 453.15 454.15 455.15 456.15 457.15 458.15 459.15 460.15 461.15 462.15 463.15 464.15 465.15 466.15 467.15 468.15 469.15 470.15 471.15 472.15 473.15 474.15 475.15 476.15 477.15 478.15 479.15 480.15 481.15 482.15 483.15 484.15 485.15 486.15 487.15 488.15 489.15 490.15 491.15 492.15 493.15 494.15 495.15 496.15 497.15 498.15 499.15 500.15 501.15 502.15 503.15 504.15 505.15 506.15 507.15 508.15 509.15 510.15 511.15 512.15' 
    y = '2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.420000e+04 2.451700e+04 2.546500e+04 2.703400e+04 2.920600e+04 3.195700e+04 3.525800e+04 3.907200e+04 4.335700e+04 4.806700e+04 5.315000e+04 5.855000e+04 6.420800e+04 7.006200e+04 7.604800e+04 8.210000e+04 8.815200e+04 9.413800e+04 9.999200e+04 1.056500e+05 1.110500e+05 1.161300e+05 1.208400e+05 1.251300e+05 1.289400e+05 1.322400e+05 1.349900e+05 1.371700e+05 1.387300e+05 1.396800e+05 1.400000e+05 1.399700e+05 1.398600e+05 1.396900e+05 1.394500e+05 1.391500e+05 1.387800e+05 1.383400e+05 1.378300e+05 1.372600e+05 1.366200e+05 1.359200e+05 1.351600e+05 1.343400e+05 1.334500e+05 1.325100e+05 1.315100e+05 1.304500e+05 1.293400e+05 1.281700e+05 1.269500e+05 1.256800e+05 1.243600e+05 1.230000e+05 1.215900e+05 1.201300e+05 1.186400e+05 1.171000e+05 1.155300e+05 1.139300e+05 1.122900e+05 1.106200e+05 1.089200e+05 1.072000e+05 1.054500e+05 1.036800e+05 1.019000e+05 1.000900e+05 9.827800e+04 9.645000e+04 9.461300e+04 9.277100e+04 9.092400e+04 8.907600e+04 8.722900e+04 8.538700e+04 8.355000e+04 8.172200e+04 7.990600e+04 7.810300e+04 7.631700e+04 7.454900e+04 7.280300e+04 7.107900e+04 6.938200e+04 6.771300e+04 6.607400e+04 6.446800e+04 6.289700e+04 6.136300e+04 5.986800e+04 5.841400e+04 5.700400e+04 5.563800e+04 5.431900e+04 5.305000e+04 5.183000e+04 5.066300e+04 4.954900e+04 4.849100e+04 4.748900e+04 4.654600e+04 4.566100e+04 4.483800e+04 4.407600e+04 4.337600e+04 4.274100e+04 4.217000e+04 4.166400e+04 4.122400e+04 4.085100e+04 4.054500e+04 4.030700e+04 4.013700e+04 4.003400e+04 4.000000e+04 4.003400e+04 4.013700e+04 4.030700e+04 4.054500e+04 4.085100e+04 4.122400e+04 4.166400e+04 4.217000e+04 4.274100e+04 4.337600e+04 4.407600e+04 4.483800e+04 4.566100e+04 4.654600e+04 4.748900e+04 4.849100e+04 4.954900e+04 5.066300e+04 5.183000e+04 5.305000e+04 5.431900e+04 5.563800e+04 5.700400e+04 5.841400e+04'
  []
[]

[FluidProperties]
  [water]
    type = SimpleFluidProperties
  []
[]

[Closures]
  [thm_closures]
    type = Closures1PhaseSimple
  []
[]

[Components]
  [pipe1]
    type = FlowChannel1Phase
    position = '-0.5 0 0'
    # position = '-0.5 0.2 0'
    orientation = '1 0 0' # flows from right to left (heated to unheated)
    length = 1
    n_elems = ${n_elems_axial}

    A   = ${fparse pi * core_dia * core_dia / 4.}
    D_h = ${core_dia}
    f = 0.1 # friction factor

    fp = water # fluid properties
  []

  [hxconn]
    # type = HeatTransferFromExternalAppTemperature1Phase
    type = HeatTransferFromExternalAppHeatFlux1Phase
    flow_channel = pipe1
    Hw = water-htc-function
    # initial_T_wall = ${inlet_temp}
    P_hf = ${fparse pi*core_dia}
    # T_ext = "T_ext"
  []

  [inlet]
    type = InletMassFlowRateTemperature1Phase
    input = 'pipe1:in'
    m_dot = ${fparse vol_flowrate * density}
    T = ${inlet_temp}
  []

  [outlet]
    type = Outlet1Phase
    input = 'pipe1:out'
    p = ${p_out}
  []
[]

[Preconditioning]
  [SMP_PJFNK]
    type = SMP
    full = true
  []
[]

[Executioner]
  type = Transient
  scheme = 'bdf2'
  dt = 5
  dtmin = 1e-12
  abort_on_solve_fail = true

  solve_type = 'NEWTON'
  line_search = 'basic'
  # nl_rel_tol = 1e-7
  nl_abs_tol = 1e-8
  nl_max_its = 20

  l_tol = 1e-4
  l_max_its = 300

  start_time = 0.0
  #end_time = 500
  # dt = 5
  num_steps = 200
[]

[Outputs]
  exodus = true
  print_linear_residuals = false
[]
